import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";

// Set environment variables before any imports
process.env.JWT_SECRET = "test-secret-key-at-least-32-characters-long";
process.env.PORT = "3001";

// Mock all dependencies before importing main
vi.mock("dotenv", () => ({
	config: vi.fn(),
}));

vi.mock("./JwtService.js", () => ({
	JwtService: vi.fn().mockImplementation(() => ({
		verifyToken: vi.fn(),
	})),
}));

vi.mock("./db.js", () => ({
	DbInitializer: vi.fn().mockImplementation(() => ({
		initialize: vi.fn().mockResolvedValue(undefined),
	})),
	db: {},
}));

vi.mock("./prisma.js", () => ({
	prisma: {},
}));

vi.mock("./server.js", () => ({
	ServerApp: vi.fn().mockImplementation(() => ({
		start: vi.fn().mockResolvedValue(undefined),
		stop: vi.fn().mockResolvedValue(undefined),
	})),
}));

vi.mock("./modules/logger/core/logger.js", () => ({
	logger: {
		info: vi.fn(),
		error: vi.fn(),
		warn: vi.fn(),
	},
}));

describe("Application Entry Point", () => {
	beforeEach(() => {
		vi.clearAllMocks();
	});

	afterEach(() => {
		vi.restoreAllMocks();
	});

	it("should load environment variables and start application successfully", async () => {
		const { config } = await import("dotenv");
		const { DbInitializer } = await import("./db.js");
		const { ServerApp } = await import("./server.js");
		const { logger } = await import("./modules/logger/core/logger.js");

		// Import main to trigger the application startup
		await import("./index.js");

		expect(config).toHaveBeenCalled();
		expect(DbInitializer).toHaveBeenCalled();
		expect(ServerApp).toHaveBeenCalled();
		expect(logger.info).toHaveBeenCalledWith("ðŸš€ Starting application...");
		expect(logger.info).toHaveBeenCalledWith("âœ… Application started successfully");
	});
});
