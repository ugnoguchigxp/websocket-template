import { config } from "dotenv";
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
import { logger } from "../modules/logger/core/logger.js";
import { EnvironmentService } from "./EnvironmentService.js";

// Mock dependencies
vi.mock("dotenv", () => ({
	config: vi.fn(),
}));

vi.mock("../modules/logger/core/logger.js", () => ({
	logger: {
		warn: vi.fn(),
		debug: vi.fn(),
	},
}));

describe("EnvironmentService", () => {
	let service: EnvironmentService;
	let originalEnv: NodeJS.ProcessEnv;
	let mockConfig: any;

	beforeEach(() => {
		vi.clearAllMocks();
		originalEnv = { ...process.env };
		process.env = { ...originalEnv };
		mockConfig = vi.mocked(config);
		service = new EnvironmentService("/app/api");
	});

	afterEach(() => {
		process.env = originalEnv;
		vi.restoreAllMocks();
	});

	describe("loadEnvironment", () => {
		it("should load environment variables from .env file", () => {
			mockConfig.mockReturnValue({ error: null });

			const result = service.loadEnvironment();

			expect(mockConfig).toHaveBeenCalledWith({
				path: expect.stringContaining(".env"),
			});
			expect(result).toBe(process.env);
		});

		it("should warn when .env file is not found", () => {
			mockConfig.mockReturnValue({ error: new Error("File not found") });

			service.loadEnvironment();

			expect(logger.warn).toHaveBeenCalledWith(
				"No .env file found, using system environment variables"
			);
		});
	});

	describe("validateEnvironment", () => {
		it("should throw error when JWT_SECRET is not set", () => {
			delete process.env.JWT_SECRET;

			expect(() => service.validateEnvironment()).toThrow(
				"JWT_SECRET must be set and at least 32 characters"
			);
		});

		it("should throw error when JWT_SECRET is too short", () => {
			process.env.JWT_SECRET = "short";

			expect(() => service.validateEnvironment()).toThrow(
				"JWT_SECRET must be set and at least 32 characters"
			);
		});

		it("should validate successfully in development with valid JWT_SECRET", () => {
			process.env.NODE_ENV = "development";
			process.env.JWT_SECRET = "valid-secret-key-that-is-at-least-32-characters-long";
			process.env.JWT_ISSUER = "test-issuer";
			process.env.JWT_AUDIENCE = "test-audience";

			expect(() => service.validateEnvironment()).not.toThrow();
		});

		it("should throw error when ALLOWED_WS_ORIGIN is not set in production", () => {
			process.env.NODE_ENV = "production";
			process.env.JWT_SECRET = "valid-secret-key-that-is-at-least-32-characters-long";
			delete process.env.ALLOWED_WS_ORIGIN;

			expect(() => service.validateEnvironment()).toThrow(
				"ALLOWED_WS_ORIGIN must be set in production"
			);
		});

		it("should throw error when DATABASE_URL uses dev.db in production", () => {
			process.env.NODE_ENV = "production";
			process.env.JWT_SECRET = "valid-secret-key-that-is-at-least-32-characters-long";
			process.env.ALLOWED_WS_ORIGIN = "https://example.com";
			process.env.DATABASE_URL = "file:dev.db";

			expect(() => service.validateEnvironment()).toThrow(
				"Production DATABASE_URL must not use dev.db"
			);
		});

		it("should validate successfully in production with all required variables", () => {
			process.env.NODE_ENV = "production";
			process.env.JWT_SECRET = "valid-secret-key-that-is-at-least-32-characters-long";
			process.env.ALLOWED_WS_ORIGIN = "https://example.com";
			process.env.DATABASE_URL = "file:production.db";

			expect(() => service.validateEnvironment()).not.toThrow();
		});
	});

	describe("getPort", () => {
		it("should return default port when PORT is not set", () => {
			delete process.env.PORT;

			const port = service.getPort();

			expect(port).toBe(3001);
		});

		it("should return custom port when PORT is set", () => {
			process.env.PORT = "8080";

			const port = service.getPort();

			expect(port).toBe(8080);
		});
	});

	describe("getJwtSecret", () => {
		it("should throw error when JWT_SECRET is not set", () => {
			delete process.env.JWT_SECRET;

			expect(() => service.getJwtSecret()).toThrow(
				"JWT_SECRET must be set and at least 32 characters"
			);
		});

		it("should throw error when JWT_SECRET is too short", () => {
			process.env.JWT_SECRET = "short";

			expect(() => service.getJwtSecret()).toThrow(
				"JWT_SECRET must be set and at least 32 characters"
			);
		});

		it("should return JWT_SECRET when valid", () => {
			process.env.JWT_SECRET = "valid-secret-key-that-is-at-least-32-characters-long";

			const secret = service.getJwtSecret();

			expect(secret).toBe("valid-secret-key-that-is-at-least-32-characters-long");
		});
	});
});
